# 数据库主键

- 对于非核心业务，如告警，日志，监控等信息，可以使用主键自增ID
- 对于核心业务，主键必须全局唯一且单调递增。全局唯一是满足分布式系统，单调递增满足插入时性能问题

## 1. 自增ID

- 除了实现简单，其他都是缺点

```bash
# 安全性差
- 对外暴露的借口可以非常容易猜测对应的信息
- /user/1，猜测用户id的值为1，总用户数量多少

# 性能差
- 自增ID的性能比较差，需要在数据库服务器端生成

# 交互多
- 业务需要额外执行一次类似last_insert_id()的函数，才能知道刚才插入的自增值，就会多一次网络交互
- 海量并发的系统中，多1条sql，就会多一次性能开销

# 局部唯一
- 自增id是局部唯一，只在当前数据库实例中唯一，而不是全局唯一
- 不适合分布式系统
```

## 2. UUID

![image-20230918111020583](https://erick-typora-image.oss-cn-shanghai.aliyuncs.com/img/image-20230918111020583.png)

```sql
# mysql获取
SELECT UUID() FROM DUAL;

# 占用36个字节
- 底层用字符串存储
- 除了要用的32个字节，还有4个 - 连接符
```

### 2.1 全局唯一性

```bash
# 时间
- 时间部分占用60位，存储的类似TIMESTAMP的时间戳，时间范围：1582-10-15 00:00:00 到现在的100ns的计数
- 精度比timestamp高，时间唯独发生重复的概率降低到1/100ns
- 低位：秒     中位：分     高位：时

# 时钟序列
- 为了避免时钟被回拨导致产生时间重复，从而导致的单体服务的UUID重复性

# Mac地址
- 用户全局唯一
- 服务器的物理地址：可能暴露服务器的地址
```

### 2.3 无序非单调递增

## 3. 改造UUID

- 为了使主键是单调递增的，可以更换UUID的时间高位和时间低位
- 去除UUID字符串中的“-”字符串，将字符串用二进制类型保存，降低存储空间为16个字节

